<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>é¹¿ğŸ¦Œçš„QAç¶²ç«™</title>
  <meta name="theme-color" content="#0f1220" />
  <link rel="icon" type="image/png" href="ç¶²ç«™é ‚ç«¯icon.JPG">
  <link rel="stylesheet" href="styles.css?v=20251009-super" />
</head>
<body>
  <!-- å…¨é è¼‰å…¥é®ç½© -->
  <div id="page-loading" aria-live="polite" aria-busy="true">
    <div class="card">
      <div class="spinner"><img src="è½‰åœˆåœˆ.png" alt="è¼‰å…¥ä¸­" class="loading-img"></div>
      <div class="title">ç¶²é è¼‰å…¥ä¸­ï¼Œè«‹ç¨å€™â€¦</div>
      <div class="muted" style="font-size:.9rem">æ­£åœ¨æº–å‚™è³‡æ–™èˆ‡ä»‹é¢</div>
    </div>
  </div>

  <!-- ç°¡æ˜“å…¬å‘Šèˆ‡ç‰ˆæœ¬èªŒ -->
  <div id="changelog" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="cg-title">
    <div class="modal-card">
      <div class="modal-header">
        <h2 id="cg-title">ğŸ¦Œ ç¶²ç«™æ›´æ–°</h2>
        <button id="cg-close" class="btn ghost">æˆ‘çŸ¥é“äº†ï¼Œé—œé–‰è¦–çª—âŒ</button>
      </div>
      <div class="modal-body" id="cg-body"></div>
    </div>
  </div>

  <div id="ann-modal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="ann-title">
    <div class="modal-card">
      <div class="modal-header">
        <h2 id="ann-title">ç¶²ç«™å…¬å‘Š</h2>
        <button id="ann-close" class="btn ghost">âŒé—œé–‰å…¬å‘Š</button>
      </div>
      <div class="modal-body" id="ann-body"></div>
    </div>
  </div>

  <!-- éŒ¯èª¤è¨Šæ¯æ©«å¹…ï¼ˆè³‡æº404/JSéŒ¯èª¤ï¼‰ -->
  <div id="errbar" class="errbar hidden" role="status" aria-live="assertive"></div>

  <header class="hero">
    <div class="brand">
      <img id="logo-img" src="Logo.png" class="logo-img" alt="é¹¿ Logo" />
      <div>
        <h1>é¹¿ğŸ¦Œçš„QAç¶²ç«™</h1>
        <p class="muted">æŸ¥è©¢è³‡æ–™åº«èˆ‡è§€çœ‹å½±ç‰‡èˆ‡ç‰¹æ•ˆã€‚è‹¥æœ‰éŒ¯èª¤ï¼Œè«‹å›å ±å·¥ç¨‹å¸«ã€‚</p>
      </div>
    </div>

    <div class="top-actions">
      <button id="site-bell" class="btn ghost icon" title="å…¬å‘Š" aria-label="å…¬å‘Š">ğŸ”” <span class="muted" style="font-size:.9rem">å…¬å‘Š</span></button>
      <button id="site-share" class="btn icon share-top" title="åˆ†äº«ç¶²ç«™" aria-label="åˆ†äº«ç¶²ç«™">åˆ†äº«</button>
      <a id="contact-eng" class="btn ghost icon" href="mailto:wanglien214@gmail.com" title="è¯çµ¡å·¥ç¨‹å¸«" aria-label="è¯çµ¡å·¥ç¨‹å¸«">ğŸ“§ <span class="muted" style="font-size:.9rem">è¯çµ¡å·¥ç¨‹å¸«</span></a>
    </div>

    <nav class="tabs" role="tablist" aria-label="ä¸»è¦åŠŸèƒ½">
      <button id="tab-qa" class="tab active" role="tab" aria-selected="true" aria-controls="qa-panel">QA</button>
      <button id="tab-video" class="tab" role="tab" aria-selected="false" aria-controls="video-panel">å½±ç‰‡</button>
      <button id="tab-effect" class="tab" role="tab" aria-selected="false" aria-controls="effect-panel">ç‰¹æ•ˆ</button>
    </nav>

    <div id="qa-toolbar" class="search-wrap">
      <input id="search" class="input" type="search" placeholder="è¼¸å…¥é—œéµå­—ï¼ˆå‚³çµ±æ¯”å°ï¼‰" aria-label="æœå°‹ QA" />
      <button id="clear" class="btn ghost">æ¸…é™¤</button>
    </div>

    <div class="stats" id="qa-stats">
      <div class="stat"><span id="stat-total" class="value">0</span><span class="label">ç¸½ç­†æ•¸</span></div>
      <div class="stat"><span id="stat-page" class="value">1</span><span class="label">ç›®å‰é </span></div>
      <div class="stat"><span id="stat-pages" class="value">1</span><span class="label">ç¸½é æ•¸</span></div>
      <div class="stat"><span id="stat-filtered" class="value">0</span><span class="label">ç›®å‰ç¯©é¸</span></div>
    </div>
  </header>

  <main class="container">
    <!-- QA -->
    <section id="qa-panel" class="tabpanel" role="tabpanel" aria-labelledby="tab-qa">
      <section id="qa-list" class="accordion"></section>
      <nav class="pager" aria-label="åˆ†é å°è¦½">
        <button id="prev" class="btn">ä¸Šä¸€é </button>
        <input id="page" class="page-input" type="text" inputmode="numeric" pattern="[0-9]*" value="1" aria-label="è·³è‡³é ç¢¼">
        <span class="slash">/</span>
        <span id="pages" class="pages-badge">1</span>
        <button id="next" class="btn">ä¸‹ä¸€é </button>
      </nav>
      <footer class="footer" aria-hidden="true" style="visibility:hidden;height:0;padding:0;margin:0"></footer>
    </section>

    <!-- å½±ç‰‡ -->
    <section id="video-panel" class="tabpanel hidden" role="tabpanel" aria-labelledby="tab-video">
      <div class="video-layout">
        <div class="video-left">
          <div class="video-controls top">
            <button id="v-random" class="btn">éš¨æ©Ÿå½±ç‰‡</button>
            <!-- ç›®éŒ„æŒ‰éˆ•ç”± JS æ³¨å…¥ -->
          </div>
          <div class="video-header">
            <span id="v-title" class="video-title">æœªé¸æ“‡å½±ç‰‡</span>
            <button id="v-info-btn" class="info-btn" title="å½±ç‰‡è³‡è¨Š">â„¹ï¸</button>
          </div>
          <div id="v-frame" class="video-frame"></div>
        </div>
        <div class="video-right" id="v-list"></div>
      </div>
    </section>

    <!-- ç‰¹æ•ˆ -->
    <section id="effect-panel" class="tabpanel hidden" role="tabpanel" aria-labelledby="tab-effect">
  <div class="effect-pro">
    <!-- å·¦ï¼šæ‰‹æ©Ÿé è¦½ï¼ˆ9:16ï¼‰ -->
    <div class="effect-phone">
      <div class="phone-bezel">
        <div class="phone-notch"></div>
        <div class="phone-screen">
          <!-- Demo åœ–ï¼šç”¨ TikTok é è¨­ç¤ºç¯„ç…§ï¼Œç­‰æ¯”ç½®ä¸­å¡«æ»¿ -->
          <img id="effect-demo" alt="ç‰¹æ•ˆç¤ºç¯„é è¦½" class="phone-preview" />
        </div>
      </div>
      <p class="muted effect-caption">ç‰¹æ•ˆåœ–ç‰‡å·²ç¶“ç¶“éé¹¿ğŸ¦ŒåŒæ„äº†å–”ï½</p>
    </div>

    <!-- å³ï¼šè³‡è¨Šå€ -->
    <aside class="effect-side card">
      <header class="side-head">
        <h3 id="effect-title" class="side-title">TikTok ç‰¹æ•ˆ</h3>
        <div class="side-actions">
          <button id="effect-play" class="btn primary">ç«‹å³é«”é©—</button>
          <a id="effect-open-new" class="btn ghost" target="_blank" rel="noopener">æ–°åˆ†é é–‹å•Ÿ</a>
        </div>
      </header>

      <div class="side-body">
        <ul class="bullets">
          <li>æƒæ QR æˆ–æŒ‰ã€Œç«‹å³é«”é©—ã€é–‹å•Ÿ TikTok ç‰¹æ•ˆ</li>
          <li>å»ºè­°ä½¿ç”¨æ‰‹æ©Ÿç›´å¼éŒ„è£½ï¼Œå–å¾—æœ€ä½³è¦–è¦ºæ¯”ä¾‹</li>
        </ul>

        <div class="qr-wrap">
          <img id="effect-qr" alt="æƒæé–‹å•Ÿç‰¹æ•ˆ" class="qr-img" />
          <div class="qr-meta">
            <div class="label">é è¦½é€£çµï¼ˆTikTokï¼‰</div>
            <code class="qr-url" id="effect-url-copy"></code>
            <button class="btn ghost" id="copy-effect-url">è¤‡è£½é€£çµ</button>
          </div>
        </div>
      </div>
    </aside>
  </div>
</section>
  </main>

  <!-- å½±ç‰‡è³‡è¨Š -->
  <div id="info-modal" class="modal hidden" role="dialog" aria-modal="true">
    <div class="modal-card small">
      <div class="modal-header">
        <h3>å½±ç‰‡è³‡è¨Š</h3>
        <button id="modal-close" class="btn ghost">âŒé—œé–‰å½±ç‰‡è³‡è¨Š</button>
      </div>
      <div class="modal-body" id="modal-body"></div>
    </div>
  </div>

  <!-- AI FAB -->
  <button id="ai-fab" class="ai-fab" aria-label="é–‹å•Ÿ AI éº‹é¹¿">
    <svg width="26" height="26" viewBox="0 0 24 24"><path fill="currentColor" d="M4 4h16v10H7l-3 3V4z"/><circle cx="9" cy="9" r="1.5" fill="#0f1220"/><circle cx="14" cy="9" r="1.5" fill="#0f1220"/></svg>
  </button>

  <aside id="ai-panel" class="ai-panel hidden" role="dialog" aria-modal="true" aria-labelledby="ai-title">
    <header class="ai-header"><h2 id="ai-title">AIéº‹é¹¿</h2><button id="ai-close" class="btn ghost" aria-label="é—œé–‰">âŒé—œé–‰èŠå¤©å®¤</button></header>
    <div id="ai-messages" class="ai-messages"></div>
    <form id="ai-form" class="ai-input" autocomplete="off">
      <input id="ai-text" class="input ai-inputbox" placeholder="è¼¸å…¥ä¸¦æŒ‰ Enter é€å‡º" aria-label="AIè¼¸å…¥">
      <div style="display:flex;gap:8px">
        <button id="ai-mic" class="btn ghost" type="button" title="èªéŸ³è¼¸å…¥">ğŸ™ï¸</button>
        <button id="ai-tts" class="btn ghost" type="button" title="èªéŸ³æœ—è®€">ğŸ”Š</button>
        <button class="btn primary" type="submit">é€å‡º</button>
      </div>
    </form>
  </aside>

  <!-- æ—¢æœ‰è…³æœ¬ -->
  <script src="deer-qa.js"></script>
  <script src="app.js"></script>
  <script src="qa-accordion-fix.js?v=super"></script>
  <script src="deer-video-min.js"></script>

  <!-- è¶…ç´šç‰ˆæ ¸å¿ƒåˆå§‹åŒ– -->
  <script>
/* ===== ä¾¿åˆ©å·¥å…· ===== */
const LOADER_IMG={global:'è½‰åœˆåœˆ.png',page:'è½‰åœˆåœˆ.png','tab-qa':'è½‰åœˆåœˆ.png','tab-video':'è½‰åœˆåœˆ.png','tab-effect':'è½‰åœˆåœˆ.png',video:'è½‰åœˆåœˆ.png','ai-open':'è½‰åœˆåœˆ2.png','ai-close':'è½‰åœˆåœˆ2.png'};
const $ = (sel,root=document)=>root.querySelector(sel);
const $$ = (sel,root=document)=>Array.from(root.querySelectorAll(sel));
const on = (el,ev,fn,opt)=>el&&el.addEventListener(ev,fn,opt);
window.escapeHTML||=(s)=>String(s||'').replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
/* ===== å…¨é  Loader ===== */
(function bootLoader(){
  const root=document.querySelector('#page-loading'); if(!root) return;
  const img=root.querySelector('.loading-img'); if(img) img.src=(window.LOADER_IMG?.global)||'è½‰åœˆåœˆ.png';
  document.body.style.overflow='hidden';

  const first = !sessionStorage.getItem('siteLoadedOnce');
  sessionStorage.setItem('siteLoadedOnce','1');

  const start = Date.now();
  // ç¬¬ä¸€æ¬¡ 4â€“10 ç§’ï¼›å…¶å¾Œ 3â€“6 ç§’ï¼›æ•´é«”ä»ä¿ 3â€“10 ç§’å€é–“
  const target = first
    ? Math.floor(4000 + Math.random()*6000)
    : Math.floor(3000 + Math.random()*3000);

  function kill(){
    const elapsed = Date.now() - start;
    const wait = Math.max(0, target - elapsed);
    setTimeout(()=>{
      root.classList.add('hide');
      root.addEventListener('transitionend', ()=>{
        root.remove(); document.body.style.overflow='';
      }, {once:true});
    }, wait);
  }
  window.addEventListener('load', kill, {once:true});
  // ä¿éšªï¼šæœ€æ…¢ target+1.5s ä¹Ÿæœƒé—œ
  setTimeout(kill, target + 1500);
})();
const Loading=(()=>{const MIN=800,map=new Map();
  function lock(on){document.body.style.overflow=on?'hidden':'';}
  function ensure(id,text='è¼‰å…¥ä¸­ï¼Œè«‹ç¨å€™â€¦',key='global'){let el=document.getElementById(id);const src=LOADER_IMG[key]||LOADER_IMG.global||'è½‰åœˆåœˆ.png';
    if(!el){el=document.createElement('div');el.id=id;el.className='page-overlay';el.setAttribute('aria-live','polite');el.setAttribute('aria-busy','true');
      el.innerHTML=`<div class="card"><div class="spinner"><img src="${src}" alt="" class="loading-img"></div><div class="title">${text}</div><div class="muted" style="font-size:.9rem">æ­£åœ¨æº–å‚™è³‡æ–™èˆ‡ä»‹é¢</div></div>`;
      document.body.appendChild(el);} else {el.querySelector('.loading-img').src=src; const ttl=el.querySelector('.title'); if(ttl) ttl.textContent=text;}
    return el;}
  function show(key='global',text){const id=`ov-${key}`;ensure(id,text||'è¼‰å…¥ä¸­ï¼Œè«‹ç¨å€™â€¦',key).classList.remove('hide'); map.set(id,Date.now()); lock(true); return id;}
  function hide(key='global'){const id=`ov-${key}`;const el=document.getElementById(id); if(!el) return; const st=map.get(id)||Date.now(); const wait=Math.max(0,MIN-(Date.now()-st));
    setTimeout(()=>{el.classList.add('hide');el.addEventListener('transitionend',()=>{el.remove(); if(!document.querySelector('.page-overlay')&&!document.getElementById('page-loading')) lock(false);},{once:true}); map.delete(id);},wait);}
  function videoShow(){const host=$('#v-frame'); if(!host) return Date.now(); let m=host.querySelector('.mini-overlay'); const src=LOADER_IMG.video||LOADER_IMG.global||'è½‰åœˆåœˆ.png';
    if(!m){m=document.createElement('div');m.className='mini-overlay';m.innerHTML=`<div class="spinner"><img src="${src}" alt="" class="loading-img"></div>`; host.appendChild(m);} else {m.querySelector('.loading-img').src=src;}
    return Date.now();}
  function videoHide(mark){const host=$('#v-frame'); if(!host) return; const m=host.querySelector('.mini-overlay'); if(!m) return; const left=Math.max(0,600-(Date.now()-(mark||Date.now()))); setTimeout(()=>m.remove(),left);}
  return {show,hide,videoShow,videoHide};
})();

/* ===== å…¬å‘Š ===== */
const ANNOUNCEMENTS=[{id:'welcome-410',title:'V4.2 ä¸Šç·š',body:'ä¸Šæ¶ TikTok ç‰¹æ•ˆäº†ã€‚',start:'2025-10-10'}];
(function(){
  const bell = $('#site-bell');
  if(!bell) return;
  on(bell,'click',()=>{
    const now = Date.now();
    const active = ANNOUNCEMENTS.filter(a=>{
      const st = a.start ? new Date(a.start).getTime() : -Infinity;
      const ed = a.end   ? new Date(a.end).getTime()   :  Infinity;
      return now >= st && now <= ed;
    });
    const html = active.length
      ? `<div class="ann-list">${active.map(a=>`<article class="ann-item" style="margin:10px 0"><h4 style="margin:.2rem 0">${a.title}</h4><div class="muted" style="font-size:.9rem">${(a.start||'').slice(0,10)}${a.end?` â€” ${a.end.slice(0,10)}`:''}</div><p style="margin:.4rem 0 0">${a.body}</p></article>`).join('')}</div>`
      : `<p class="muted">ç›®å‰æ²’æœ‰å…¬å‘Šã€‚</p>`;
    const m = $('#ann-modal');
    m.classList.remove('hidden');
    $('#ann-body').innerHTML = html;
    on($('#ann-close'),'click',()=>m.classList.add('hidden'),{once:true});
  });
})();

/* ===== åˆ†äº« ===== */
(function shareFix(){
  const btn=$('#site-share'); if(!btn) return;
  on(btn,'click',async()=>{
    const data={title:document.title,text:'é¹¿ğŸ¦Œçš„QAç¶²ç«™',url:location.href};
    try{ if(navigator.share){await navigator.share(data);} else {await navigator.clipboard.writeText(location.href); const old=btn.textContent; btn.textContent='å·²è¤‡è£½'; setTimeout(()=>btn.textContent=old,1200);} }
    catch{ const old=btn.textContent; btn.textContent='å–æ¶ˆ'; setTimeout(()=>btn.textContent=old,1000); }
  });
})();

/* ===== QA è¤‡è£½ï¼ˆå¼·åŒ–ç‰ˆï¼‰ ===== */
(function setupQACopy(){
  const list=document.getElementById('qa-list'); if(!list) return;

  function ensureCopyButtons(root=list){
    root.querySelectorAll('.item').forEach(item=>{
      if(item.querySelector('.tool.copy-qa')) return;
      const header=item.querySelector('.q'); if(!header) return;
      const tools=header.querySelector('.tools')||(()=>{const t=document.createElement('div');t.className='tools';t.style.marginLeft='auto';t.style.display='flex';t.style.gap='8px';header.appendChild(t);return t;})();
      const btn=document.createElement('span');
      btn.className='tool copy-qa'; btn.setAttribute('role','button'); btn.setAttribute('tabindex','0');
      btn.title='è¤‡è£½é€™å‰‡ QA'; btn.textContent='ğŸ“‹ è¤‡è£½';
      tools.appendChild(btn);
    });
  }

  function toastAt(text){
    const tip=document.createElement('div');
    tip.className='toast';
    tip.textContent=text;
    tip.style.left='50%'; tip.style.bottom='18px'; tip.style.top='auto';
    tip.style.transform='translate(-50%,0)';
    document.body.appendChild(tip);
    setTimeout(()=>tip.remove(),1650);
  }

  async function doCopy(fromEl,btn){
    const item=fromEl.closest('.item');
    const txt=item?.querySelector('.a-inner')?.innerText?.trim();
    let ok=false;
    try{ if(txt){ await navigator.clipboard.writeText(txt); ok=true; } }catch(e){ ok=false; }
    if(btn){ btn.classList.add('copied'); setTimeout(()=>btn.classList.remove('copied'),420); }
    toastAt(ok?'å·²è¤‡è£½ QA':'è¤‡è£½å¤±æ•—ï¼ˆç€è¦½å™¨é™åˆ¶ï¼‰');
  }

  document.addEventListener('click',e=>{
    const btn=e.target.closest('.tool.copy-qa,[data-copy]'); if(!btn) return;
    e.preventDefault(); doCopy(btn,btn);
  },true);
  document.addEventListener('keydown',e=>{
    if((e.key==='Enter'||e.key===' ')&&e.target.closest('.tool.copy-qa')){ e.preventDefault(); doCopy(e.target,e.target); }
  },true);

  ensureCopyButtons();
  new MutationObserver(m=>m.forEach(x=>x.addedNodes.forEach(n=>{ if(n.nodeType===1) ensureCopyButtons(n); })))
    .observe(list,{childList:true,subtree:true});
})();


/* ===== QA åˆ†é é®ç½© + æ²é ‚ ===== */
(function qaPagingOverlay(){
  const ids=['prev','next','page'], list=$('#qa-list'); if(!list) return;
  function armHide(){const mo=new MutationObserver(()=>{clearTimeout(armHide.t); armHide.t=setTimeout(()=>Loading.hide('page'),220);}); mo.observe(list,{childList:true,subtree:true}); setTimeout(()=>{mo.disconnect(); Loading.hide('page');},6000);}
  ids.forEach(id=>{const el=document.getElementById(id); if(!el) return; const evt=(id==='page')?'change':'click'; on(el,evt,()=>{Loading.show('page','åˆ‡æ›é é¢ä¸­ï¼Œè«‹ç¨å€™â€¦'); armHide(); window.scrollTo({top:0,behavior:'smooth'});});});
})();

/* ===== AI é¢æ¿é®ç½© ===== */
(function aiPanelOverlay(){
  const fab   = document.getElementById('ai-fab');
  const close = document.getElementById('ai-close');
  const panel = document.getElementById('ai-panel');
  if(!fab||!close||!panel) return;

  fab.addEventListener('click', ()=>{
    Loading.show('ai-open','é–‹å•Ÿ AI ä¸­ï¼Œè«‹ç¨å€™â€¦'); // æœƒç”¨ LOADER_IMG['ai-open'] = è½‰åœˆåœˆ2.png
    panel.classList.remove('hidden');
    panel.classList.add('show');
    setTimeout(()=>Loading.hide('ai-open'), 320); // èˆ‡ CSS éå ´æ™‚é–“å°é½Š
  });

  close.addEventListener('click', ()=>{
    Loading.show('ai-close','é—œé–‰ AI ä¸­â€¦'); // æœƒç”¨ LOADER_IMG['ai-close'] = è½‰åœˆåœˆ2.png
    panel.classList.remove('show');
    panel.classList.add('hidden');
    setTimeout(()=>Loading.hide('ai-close'), 300);
  });
})();

/* ===== åä¸€èˆ¬è¤‡è£½ï¼ˆQAç™½åå–®ï¼‰ ===== */
(function antiCopy(){
  on(document,'contextmenu', e=>e.preventDefault(), true);
  on(document,'copy', e=>{ if(!e.target.closest('#qa-list')) e.preventDefault(); }, true);
  on(document,'cut',  e=>e.preventDefault(), true);
  on(document,'dragstart', e=>e.preventDefault(), true);
  $('#logo-img')?.setAttribute('draggable','false');
})();

/* ===== Tabs åˆ‡æ›ï¼ˆQA / å½±ç‰‡ / ç‰¹æ•ˆï¼‰ ===== */
(function tabsOverlay(){
  const tabs = $$('.tabs .tab');
  const tpMap = Object.fromEntries(tabs.map(btn=>[btn.id, btn.getAttribute('aria-controls')]));
  const panels = new Set(Object.values(tpMap));
  function show(activeId){
    tabs.forEach(btn=>{
      const on = btn.id===activeId;
      btn.classList.toggle('active',on);
      btn.setAttribute('aria-selected', String(on));
    });
    panels.forEach(pid=>{
      const panel=document.getElementById(pid);
      panel?.classList.toggle('hidden', tpMap[activeId]!==pid);
    });
  }
  tabs.forEach(btn=>{
    on(btn,'click', ()=>{
      const key = btn.id;
      Loading.show(key,'è¼‰å…¥ä¸­ï¼Œè«‹ç¨å€™â€¦');
      show(key);
      setTimeout(()=>Loading.hide(key), 360);
    });
  });
})();

/* ===== æ‰‹æ©Ÿå½±ç‰‡æŠ½å±œï¼ˆå–®ç‰ˆï¼‰ ===== */

/* ---- å…±ç”¨ï¼šå»ºç«‹å¯è‡ªå‹•æ’­æ”¾çš„ iframe ---- */
function withParams(u, obj){ try{const url=new URL(u, location.href); Object.entries(obj||{}).forEach(([k,v])=>url.searchParams.set(k,String(v))); return url.toString(); }catch{return u;} }
function isYouTube(u){ return /youtube\.com|youtu\.be/.test(u||''); }
function buildPlayerHTML(src){
  // åƒ…é–‹æ”¾éœ€è¦çš„æ¬Šé™ï¼›ä¸å« accelerometerï¼Œä¹Ÿä¸åœ¨ allow å…§æ”¾ fullscreenï¼ˆé¿å…è­¦å‘Šï¼‰
  return `<iframe src="${src}"
           allow="autoplay; encrypted-media; picture-in-picture"
           allowfullscreen playsinline referrerpolicy="strict-origin-when-cross-origin"
           loading="lazy"></iframe>`;
}
function tryUnmuteYouTube(ifr){
  // ä½¿ç”¨è€…å‰›é»æ“Šæ¸…å–® => å±¬æ–¼ã€Œä½¿ç”¨è€…æ‰‹å‹¢ã€ï¼Œå¯è¦æ±‚å–æ¶ˆéœéŸ³èˆ‡æ’­æ”¾
  let tries = 0;
  const tick = setInterval(()=>{
    tries++;
    try{
      if (!ifr.contentWindow) return;
      ifr.contentWindow.postMessage(JSON.stringify({event:'command',func:'unMute'}), '*');
      ifr.contentWindow.postMessage(JSON.stringify({event:'command',func:'setVolume',args:[100]}), '*');
      ifr.contentWindow.postMessage(JSON.stringify({event:'command',func:'playVideo'}), '*');
    }catch{}
    if (tries>12) clearInterval(tick); // æœ€å¤šå˜—è©¦ ~3.6s
  }, 300);
}

function playVideoFromItem(item){
  const frame = document.getElementById('v-frame');
  const vTitle = document.getElementById('v-title');
  if(!item || !frame) return;

  // é—œæŠ½å±œï¼ˆç›®éŒ„ï¼‰
  document.body.classList.remove('catalog-open');

  try{
    const data = JSON.parse(item.dataset.video || '{}');
    const raw  = data.url || '';
    const yt   = isYouTube(raw);
    const src  = yt
      ? withParams(raw, {autoplay:1, mute:1, playsinline:1, enablejsapi:1})
      : withParams(raw, {autoplay:1, playsinline:1});

    frame.innerHTML = `<div class="video-embed">${buildPlayerHTML(src)}</div>`;
    if(vTitle) vTitle.textContent = data.title || 'å½±ç‰‡';

    const mark = Loading?.videoShow?.();
    const ifr  = frame.querySelector('iframe');
    ifr?.addEventListener('load', ()=>{
      Loading?.videoHide?.(mark);
      if (yt) tryUnmuteYouTube(ifr);
    }, {once:true});

    frame.scrollIntoView({behavior:'smooth', block:'start'});
    setTimeout(()=>ifr?.focus?.(), 300);
  }catch{}
}

/* ---- å·¦å³æ¬„æ¸…å–®ï¼šé»ä¸€æ¬¡æ¸²æŸ“ + å°é®ç½© + è‡ªå‹•æ’­æ”¾/è§£éœéŸ³ ---- */
(function videoClickOnce(){
  const list=document.getElementById('v-list');
  if(!list) return;
  let lock=false;
  list.addEventListener('click', e=>{
    const item = e.target.closest('[data-video]'); if(!item) return;
    if(lock) return; lock=true; setTimeout(()=>lock=false,480);
    playVideoFromItem(item);
  }, true);
})();



/* ===== æ‰‹æ©Ÿå½±ç‰‡æŠ½å±œï¼ˆç›®éŒ„ UIï¼‰ ===== */
(function setupVideoCatalog(){
  const header = document.querySelector('.video-controls.top');
  const list   = document.getElementById('v-list');
  const frame  = document.getElementById('v-frame');
  const vTitle = document.getElementById('v-title');
  if(!header || !list || !frame) return;

  let dirBtn = document.getElementById('v-dir');
  if(!dirBtn){
    dirBtn = document.createElement('button');
    dirBtn.id = 'v-dir';
    dirBtn.className = 'btn ghost';
    dirBtn.textContent = 'ç›®éŒ„';
    header.appendChild(dirBtn);
  }

  let catalog = document.getElementById('v-catalog');
  if(!catalog){
    catalog = document.createElement('div');
    catalog.id = 'v-catalog';
    catalog.innerHTML = `
      <div id="v-cat-head">
        <div id="v-cat-title">å½±ç‰‡ç›®éŒ„</div>
        <button id="v-cat-close" aria-label="é—œé–‰">âŒé—œé–‰å½±ç‰‡ç›®éŒ„</button>
      </div>
      <div id="v-cat-body"></div>
    `;
    document.body.appendChild(catalog);
  }

  const body = catalog.querySelector('#v-cat-body');
  if(body && list.parentElement !== body){ body.appendChild(list); }

  const open  = ()=>document.body.classList.add('catalog-open');
  const close = ()=>document.body.classList.remove('catalog-open');

  dirBtn.onclick = open;
  catalog.querySelector('#v-cat-close').onclick = close;

  catalog.addEventListener('click', e=>{
    const inBody = body.contains(e.target);
    const inHead = catalog.querySelector('#v-cat-head').contains(e.target);
    if(!inBody && !inHead) close();
  });
  window.addEventListener('keydown', e=>{ if(e.key==='Escape') close(); }, true);

  // åœ¨ç›®éŒ„å…§é»å½±ç‰‡ï¼šè‡ªå‹•é—œé–‰ä¸¦æ’­æ”¾
  catalog.addEventListener('click', e=>{
    const item = e.target.closest('[data-video]');
    if(!item) return;
    playVideoFromItem(item);
  }, true);

  // éµç›¤æ”¯æ´ï¼šEnter/Space é¸å–æ¸…å–®
  catalog.addEventListener('keydown', e=>{
    if((e.key==='Enter' || e.key===' ') && e.target.closest('[data-video]')){
      e.preventDefault();
      const item = e.target.closest('[data-video]');
      playVideoFromItem(item);
    }
  }, true);
})();

/* ===== ç‰¹æ•ˆè³‡æ–™ ===== */
const EFFECT_INFO = Object.freeze({
  title: 'é¹¿ğŸ¦Œè¶…å¥½ç¬‘ç‰¹æ•ˆ',
  url: 'https://www.tiktok.com/?schema_type=33&object_id=preview_wEnw62RCN8wGnjzs2xwf6W',
  qr:  'QR Code.png',
  demo:'é è¨­ç¤ºç¯„ç…§.png'
});
(function setupEffectPanel(){
  const play=$('#effect-play');
  const openNew=$('#effect-open-new');
  const qr=$('#effect-qr');
  const ttl=$('#effect-title');
  const demo=$('#effect-demo');
  if(!play||!qr||!ttl||!demo||!openNew) return;
  ttl.textContent = EFFECT_INFO.title || 'TikTok ç‰¹æ•ˆ';
  qr.src   = EFFECT_INFO.qr   || '';
  demo.src = EFFECT_INFO.demo || '';
  play.addEventListener('click',()=>{ location.href = EFFECT_INFO.url; });
  openNew.href = EFFECT_INFO.url;
  // åœ–ç‰‡404 fallback
  [qr,demo].forEach(img=>img.addEventListener('error',()=>{img.classList.add('img-error'); img.alt='åœ–ç‰‡è¼‰å…¥å¤±æ•—ï¼ˆ404ï¼‰'; showErr(`åœ–ç‰‡è¼‰å…¥å¤±æ•—ï¼š${img.getAttribute('src')} [404]`);}));
})();

/* ===== éŒ¯èª¤æ©«å¹…èˆ‡å…¨åŸŸéŒ¯èª¤æ•æ‰ ===== */
function showErr(msg){
  const bar = document.getElementById('errbar');
  bar.textContent = msg;
  bar.classList.remove('hidden');
  clearTimeout(showErr.t); showErr.t=setTimeout(()=>bar.classList.add('hidden'), 6000);
}
window.addEventListener('error', (e)=>{
  if (e && e.message) showErr(`éŒ¯èª¤ï¼š${e.message}`);
}, true);
window.addEventListener('unhandledrejection', (e)=>{
  const m = (e && e.reason && (e.reason.message||e.reason.statusText)) || 'æœªçŸ¥';
  showErr(`éé æœŸéŒ¯èª¤ï¼š${m}`);
});
  (function enhanceEffectPanel(){
    const openNew = document.getElementById('effect-open-new');
    const urlBox  = document.getElementById('effect-url-copy');
    const copyBtn = document.getElementById('copy-effect-url');
    if(openNew && urlBox){ urlBox.textContent = EFFECT_INFO.url || ''; openNew.href = EFFECT_INFO.url || '#'; }
    copyBtn?.addEventListener('click', async ()=>{
      try{ await navigator.clipboard.writeText(EFFECT_INFO.url||''); copyBtn.textContent='å·²è¤‡è£½'; setTimeout(()=>copyBtn.textContent='è¤‡è£½é€£çµ',1200);}catch{}
    });
  })();
  (function buttonPopColor(){
  function flash(el){ el.classList.add('pop'); clearTimeout(el._popT); el._popT=setTimeout(()=>el.classList.remove('pop'),900); }
  document.addEventListener('click', e=>{ const b=e.target.closest('.btn'); if(b) flash(b); }, true);
  document.addEventListener('keydown', e=>{ if((e.key==='Enter'||e.key===' ')&&e.target.closest('.btn')) flash(e.target.closest('.btn')); }, true);
})();
  </script>
</body>
</html>