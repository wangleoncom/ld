<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>é¹¿ğŸ¦Œçš„QAç¶²ç«™</title>
  <meta name="theme-color" content="#0f1220" />
  <link rel="icon" type="image/png" href="ç¶²ç«™é ‚ç«¯icon.JPG">
  <link rel="stylesheet" href="styles.css?v=20251008" />
  <!-- è£œå¼·å°‘é‡æ¨£å¼ï¼ˆLoading/Toast/å°é®ç½©/åˆ†äº«æŒ‰éˆ•å¯¬åº¦/å…¬å‘ŠOverlayï¼‰ -->
  <style>
    /* å…¨é é®ç½©ï¼ˆå¯é‡ç”¨ï¼‰ */
    .page-overlay{
      position:fixed; inset:0; z-index:9999; display:grid; place-items:center;
      background:rgba(7,11,22,.78); backdrop-filter:blur(10px); -webkit-backdrop-filter:blur(10px);
      opacity:1; transition:opacity .35s ease; pointer-events:auto;
    }
    .page-overlay.hide{ opacity:0; pointer-events:none }
    .page-overlay .card{
      width:min(360px,86vw);
      background:linear-gradient(180deg,rgba(22,26,48,.72) 0%, rgba(28,33,62,.72) 100%);
      border:1px solid rgba(255,255,255,.12); border-radius:16px; padding:20px; text-align:center; color:#f6f8ff;
      box-shadow:0 24px 60px rgba(0,0,0,.45), 0 8px 24px rgba(0,0,0,.30);
    }
    .page-overlay .spinner{ display:grid; place-items:center; margin:12px auto 8px }
    .loading-img{ width:84px; height:84px; border-radius:50%; display:block; object-fit:cover }
    /* é¦–ç•«é¢ Loader ä¹Ÿå¥—åŒæ¨£æ•ˆæœï¼ˆç”¨ä½ æä¾›çš„åœ–ç‰‡ï¼‰ */
    #page-loading{ position:fixed; inset:0; z-index:9999; display:grid; place-items:center;
      background:rgba(7,11,22,.78); backdrop-filter:blur(10px); -webkit-backdrop-filter:blur(10px);
      opacity:1; transition:opacity .35s ease; }
    #page-loading.hide{ opacity:0; pointer-events:none }
    #page-loading .card{
      width:min(360px,86vw);
      background:linear-gradient(180deg,rgba(22,26,48,.72) 0%, rgba(28,33,62,.72) 100%);
      border:1px solid rgba(255,255,255,.12); border-radius:16px; padding:20px; text-align:center; color:#f6f8ff;
      box-shadow:0 24px 60px rgba(0,0,0,.45), 0 8px 24px rgba(0,0,0,.30);
    }
    #page-loading .spinner{ display:grid; place-items:center; margin:12px auto 8px }
    #page-loading .loading-img{ width:84px; height:84px; border-radius:50%; display:block; object-fit:cover }

    /* æ’­æ”¾å™¨å°é®ç½©ï¼ˆåƒ…è¦†è“‹ iframe å€å¡Šï¼‰ */
    .mini-overlay{
      position:absolute; inset:0; display:grid; place-items:center; z-index:4;
      background:rgba(7,11,22,.68); backdrop-filter:blur(8px); -webkit-backdrop-filter:blur(8px);
    }
    .video-embed{ position:relative } /* è®“ mini-overlay èƒ½çµ•å°å®šä½ */

    /* QA è¤‡è£½ Toast */
    .toast{
      position:fixed; z-index:10000; padding:8px 12px; border-radius:10px;
      background:rgba(15,18,32,.9); color:#fff; font-weight:700; font-size:.9rem;
      box-shadow:0 10px 30px rgba(0,0,0,.35); transform:translate(-50%,0);
      animation:toast-in .18s ease-out, toast-out .28s ease-in 1.5s forwards;
    }
    @keyframes toast-in{ from{ opacity:0; transform:translate(-50%,-6px) } to{ opacity:1; transform:translate(-50%,0) } }
    @keyframes toast-out{ to{ opacity:0; transform:translate(-50%,-6px) } }

    /* è¤‡è£½æŒ‰éˆ•æ¸¸æ¨™èˆ‡æŒ‰ä¸‹å‹•ç•« */
    .tool{ cursor:pointer; user-select:none }
    .tool.copied{ transform:scale(1.06); transition:transform .18s ease }

    /* åˆ†äº«æŒ‰éˆ•ç¸®çŸ­å¯¬åº¦ï¼ˆé¿å…å­—éé•·ï¼‰ */
    #site-share{ white-space:nowrap; padding-left:12px; padding-right:12px; }

    /* å…¬å‘Š Overlayï¼ˆç°¡æ˜“ï¼‰ */
    #overlay-modal{
      position:fixed; inset:0; z-index:9998; display:grid; place-items:center;
      background:rgba(5,8,16,.68); backdrop-filter:blur(12px); -webkit-backdrop-filter:blur(12px);
    }
    #overlay-modal .modal-card{
      width:min(560px,92vw);
      background:linear-gradient(180deg,rgba(22,26,48,.92) 0%, rgba(28,33,62,.92) 100%);
      border:1px solid rgba(255,255,255,.14); border-radius:18px; box-shadow:0 24px 60px rgba(0,0,0,.45);
    }
    #overlay-modal .modal-header{ display:flex; justify-content:space-between; align-items:center; padding:12px 14px; border-bottom:1px solid rgba(255,255,255,.12) }
    #overlay-modal .modal-body{ padding:14px }
    #overlay-modal .btn{ cursor:pointer }
  </style>
</head>
<body>
  <!-- é¦–æ¬¡é€²ç«™ Loadingï¼ˆåœ–ç‰‡ç½®ä¸­ã€é–äº’å‹•ï¼‰ -->
  <div id="page-loading" aria-live="polite" aria-busy="true">
    <div class="card">
      <div class="spinner">
        <img src="è½‰åœˆåœˆ.png" alt="è¼‰å…¥ä¸­" class="loading-img">
      </div>
      <div class="title">ç¶²é è¼‰å…¥ä¸­ï¼Œè«‹ç¨å€™â€¦</div>
      <div class="muted" style="font-size:.9rem">æ­£åœ¨æº–å‚™è³‡æ–™èˆ‡ä»‹é¢</div>
    </div>
  </div>

  <!-- ç‰ˆæœ¬ç´€éŒ„ï¼ˆä¿ç•™ï¼‰ -->
  <div id="changelog" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="cg-title">
    <div class="modal-card">
      <div class="modal-header">
        <h2 id="cg-title">ğŸ¦Œ ç¶²ç«™æ›´æ–°</h2>
        <button id="cg-close" class="btn ghost">æˆ‘çŸ¥é“äº†ï¼Œé—œé–‰è¦–çª—âŒ</button>
      </div>
      <div class="modal-body" id="cg-body"></div>
    </div>
  </div>

  <!-- å…¬å‘Šï¼ˆä¿ç•™ï¼‰ -->
  <div id="ann-modal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="ann-title">
    <div class="modal-card">
      <div class="modal-header">
        <h2 id="ann-title">ç¶²ç«™å…¬å‘Š</h2>
        <button id="ann-close" class="btn ghost">âŒé—œé–‰å…¬å‘Š</button>
      </div>
      <div class="modal-body" id="ann-body"></div>
    </div>
  </div>

  <header class="hero">
    <div class="brand">
      <img id="logo-img" src="Logo.png" class="logo-img" alt="é¹¿ Logo" />
      <div>
        <h1>é¹¿ğŸ¦Œçš„QAç¶²ç«™</h1>
        <p class="muted">æŸ¥è©¢è³‡æ–™åº«èˆ‡è§€çœ‹å½±ç‰‡ã€‚è‹¥æœ‰éŒ¯èª¤ï¼Œè«‹å›å ±å·¥ç¨‹å¸«ã€‚</p>
      </div>
    </div>

    <div class="top-actions">
      <button id="site-bell" class="btn ghost icon" title="å…¬å‘Š" aria-label="å…¬å‘Š">
        ğŸ”” <span class="muted" style="font-size:.9rem">å…¬å‘Š</span>
      </button>
      <button id="site-share" class="btn icon share-top" title="åˆ†äº«ç¶²ç«™" aria-label="åˆ†äº«ç¶²ç«™">åˆ†äº«</button>
      <a id="contact-eng" class="btn ghost icon" href="mailto:wanglien214@gmail.com" title="è¯çµ¡å·¥ç¨‹å¸«" aria-label="è¯çµ¡å·¥ç¨‹å¸«">
        ğŸ“§ <span class="muted" style="font-size:.9rem">è¯çµ¡å·¥ç¨‹å¸«</span>
      </a>
    </div>

    <nav class="tabs" role="tablist" aria-label="ä¸»è¦åŠŸèƒ½">
      <button id="tab-qa" class="tab active" role="tab" aria-selected="true" aria-controls="qa-panel">QA</button>
      <button id="tab-video" class="tab" role="tab" aria-selected="false" aria-controls="video-panel">å½±ç‰‡</button>
    </nav>

    <div id="qa-toolbar" class="search-wrap">
      <input id="search" class="input" type="search" placeholder="è¼¸å…¥é—œéµå­—ï¼ˆå‚³çµ±æ¯”å°ï¼‰" aria-label="æœå°‹ QA" />
      <button id="clear" class="btn ghost">æ¸…é™¤</button>
    </div>

    <div class="stats" id="qa-stats">
      <div class="stat"><span id="stat-total" class="value">0</span><span class="label">ç¸½ç­†æ•¸</span></div>
      <div class="stat"><span id="stat-page" class="value">1</span><span class="label">ç›®å‰é </span></div>
      <div class="stat"><span id="stat-pages" class="value">1</span><span class="label">ç¸½é æ•¸</span></div>
      <div class="stat"><span id="stat-filtered" class="value">0</span><span class="label">ç›®å‰ç¯©é¸</span></div>
    </div>
  </header>

  <main class="container">
    <!-- QA -->
    <section id="qa-panel" class="tabpanel" role="tabpanel" aria-labelledby="tab-qa">
      <section id="qa-list" class="accordion"></section>
      <nav class="pager" aria-label="åˆ†é å°è¦½">
        <button id="prev" class="btn">ä¸Šä¸€é </button>
        <input id="page" class="page-input" type="text" inputmode="numeric" pattern="[0-9]*" value="1" aria-label="è·³è‡³é ç¢¼">
        <span class="slash">/</span>
        <span id="pages" class="pages-badge">1</span>
        <button id="next" class="btn">ä¸‹ä¸€é </button>
      </nav>
      <footer class="footer" aria-hidden="true" style="visibility:hidden;height:0;padding:0;margin:0"></footer>
    </section>

    <!-- å½±ç‰‡ -->
    <section id="video-panel" class="tabpanel hidden" role="tabpanel" aria-labelledby="tab-video">
      <div class="video-layout">
        <div class="video-left">
          <div class="video-controls top">
            <button id="v-random" class="btn">éš¨æ©Ÿå½±ç‰‡</button>
          </div>
          <div class="video-header">
            <span id="v-title" class="video-title">æœªé¸æ“‡å½±ç‰‡</span>
            <button id="v-info-btn" class="info-btn" title="å½±ç‰‡è³‡è¨Š">â„¹ï¸</button>
          </div>
          <div id="v-frame" class="video-frame"></div>
        </div>
        <div class="video-right" id="v-list"></div>
      </div>
    </section>
  </main>

  <!-- å½±ç‰‡è³‡è¨Š Modal -->
  <div id="info-modal" class="modal hidden" role="dialog" aria-modal="true">
    <div class="modal-card small">
      <div class="modal-header">
        <h3>å½±ç‰‡è³‡è¨Š</h3>
        <button id="modal-close" class="btn ghost">âŒé—œé–‰å½±ç‰‡è³‡è¨Š</button>
      </div>
      <div class="modal-body" id="modal-body"></div>
    </div>
  </div>

  <!-- AIéº‹é¹¿ -->
  <button id="ai-fab" class="ai-fab" aria-label="é–‹å•Ÿ AI éº‹é¹¿">
    <svg width="26" height="26" viewBox="0 0 24 24"><path fill="currentColor" d="M4 4h16v10H7l-3 3V4z"/><circle cx="9" cy="9" r="1.5" fill="#0f1220"/><circle cx="14" cy="9" r="1.5" fill="#0f1220"/></svg>
  </button>

  <aside id="ai-panel" class="ai-panel hidden" role="dialog" aria-modal="true" aria-labelledby="ai-title">
    <header class="ai-header"><h2 id="ai-title">AIéº‹é¹¿</h2><button id="ai-close" class="btn ghost" aria-label="é—œé–‰">âŒé—œé–‰èŠå¤©å®¤</button></header>
    <div id="ai-messages" class="ai-messages"></div>
    <form id="ai-form" class="ai-input" autocomplete="off">
      <input id="ai-text" class="input ai-inputbox" placeholder="è¼¸å…¥ä¸¦æŒ‰ Enter é€å‡º" aria-label="AIè¼¸å…¥">
      <div style="display:flex;gap:8px">
        <button id="ai-mic" class="btn ghost" type="button" title="èªéŸ³è¼¸å…¥">ğŸ™ï¸</button>
        <button id="ai-tts" class="btn ghost" type="button" title="èªéŸ³æœ—è®€">ğŸ”Š</button>
        <button class="btn primary" type="submit">é€å‡º</button>
      </div>
    </form>
  </aside>

  <!-- æ—¢æœ‰è…³æœ¬ -->
  <script src="deer-qa.js"></script>
  <script src="app.js"></script>
  <script src="qa-accordion-fix.js"></script>
  <script src="deer-video-min.js"></script>

  <!-- é å…§è£œå¼·è…³æœ¬ï¼ˆéƒ½æ”¾æœ€å¾Œï¼‰ -->
  <script>
/* ========= Loader åœ–ç‰‡å°ç…§è¡¨ï¼ˆç›´æ¥æ”¹æª”åå³å¯ï¼‰ ========= */
const LOADER_IMG = {
  global : 'è½‰åœˆåœˆ.png',   // é¦–æ¬¡è¼‰å…¥æ•´ç«™
  page   : 'è½‰åœˆåœˆ.png',   // QA æ›é 
  'tab-qa'   : 'è½‰åœˆåœˆ.png',    // åˆ‡åˆ° QA
  'tab-video': 'è½‰åœˆåœˆ.png', // åˆ‡åˆ° å½±ç‰‡
  video  : 'è½‰åœˆåœˆ.png',    // æ’­æ”¾å™¨å°é®ç½©
  'ai-open' : 'è½‰åœˆåœˆ2.png',       // é–‹å•Ÿ AI
  'ai-close': 'è½‰åœˆåœˆ2.png'       // é—œé–‰ AI
};

/* ========= åŸºç¤å·¥å…· ========= */
window.escapeHTML ||= (s)=>String(s||'').replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
window.scrollBottom ||= function(){ const m=document.getElementById('ai-messages'); if(m) m.scrollTop=m.scrollHeight; };

/* ========= å…¬å‘Š Overlayï¼ˆä¿®å¾©éˆ´éºï¼‰ ========= */
const Ann = (function(){
  function open({title='è¨Šæ¯', html=''}) {
    close();
    const el = document.createElement('div');
    el.id = 'overlay-modal';
    el.innerHTML = `
      <div class="modal-card">
        <div class="modal-header">
          <h2 style="margin:0;font-size:1.05rem">${title}</h2>
          <button id="ov-close" class="btn ghost">é—œé–‰</button>
        </div>
        <div class="modal-body">${html||'<p class="muted">ç›®å‰æ²’æœ‰å…¬å‘Šã€‚</p>'}</div>
      </div>`;
    document.body.appendChild(el);
    document.body.style.overflow='hidden';
    el.addEventListener('click', (e)=>{ if(e.target===el) close(); });
    el.querySelector('#ov-close')?.addEventListener('click', close);
  }
  function close(){
    const el = document.getElementById('overlay-modal');
    if(el){ el.remove(); document.body.style.overflow=''; }
  }
  return { open, close };
})();

// ä½ çš„å…¬å‘Šå…§å®¹ï¼ˆå¯è‡ªè¡Œå¢ä¿®ï¼‰
const ANNOUNCEMENTS = [
  { id:'welcome-410', title:'V4.1 ä¸Šç·š', body:'4.1æ”¯æ´èªéŸ³è¼¸å…¥èˆ‡æœ—è®€ï¼Œé»å³ä¸‹è§’ AI è©¦è©¦çœ‹ã€‚', start:'2025-10-07' }
];

(function wireAnnouncements(){
  const bell = document.getElementById('site-bell');
  if(!bell) return;
  bell.addEventListener('click', ()=>{
    const now = Date.now();
    const active = ANNOUNCEMENTS.filter(a=>{
      const st=a.start?new Date(a.start).getTime():-Infinity;
      const ed=a.end?new Date(a.end).getTime():Infinity;
      return now>=st && now<=ed;
    });
    const html = active.length
      ? `<div class="ann-list">${active.map(a=>`
           <article class="ann-item" style="margin:10px 0">
             <h4 style="margin:.2rem 0">${a.title}</h4>
             <div class="muted" style="font-size:.9rem">${(a.start||'').slice(0,10)}${a.end?` â€” ${a.end.slice(0,10)}`:''}</div>
             <p style="margin:.4rem 0 0">${a.body}</p>
           </article>`).join('')}</div>`
      : `<p class="muted">ç›®å‰æ²’æœ‰å…¬å‘Šã€‚</p>`;
    Ann.open({title:'ç¶²ç«™å…¬å‘Š', html});
  });
})();

/* ========= é¦–æ¬¡ Loadingï¼šé–ä½æ»¾å‹•èˆ‡é»æ“Šï¼Œå®Œæˆå¾Œæ¢å¾© ========= */
(function bootLoader(){
  const root = document.getElementById('page-loading'); if(!root) return;
  // å¥—ç”¨å°ç…§è¡¨åœ–ç‰‡
  const img = root.querySelector('.loading-img'); if(img) img.src = LOADER_IMG.global || img.src;

  document.body.style.overflow='hidden';
  const start = Date.now(), MIN=2200;
  function kill(){
    const wait = Math.max(0, MIN - (Date.now()-start));
    setTimeout(()=>{
      root.classList.add('hide');
      root.addEventListener('transitionend', ()=>{
        root.remove(); document.body.style.overflow='';
      }, {once:true});
    }, wait);
  }
  window.addEventListener('load', kill, {once:true});
  // ä¿åº•
  setTimeout(kill, 6000);
})();

/* ========= å¯é‡ç”¨ Loading æ¨¡çµ„ï¼ˆåˆ‡é /AI/å½±ç‰‡/QAåˆ†é éƒ½ç”¨ï¼‰ ========= */
const Loading = (() => {
  const MIN = 2200;
  const map = new Map();
  function lock(on){ document.body.style.overflow = on ? 'hidden' : ''; }
  function ensure(id, text='è¼‰å…¥ä¸­ï¼Œè«‹ç¨å€™â€¦', key='global'){
    let el = document.getElementById(id);
    const src = LOADER_IMG[key] || LOADER_IMG.global || 'è½‰åœˆåœˆ.png';
    if(!el){
      el = document.createElement('div');
      el.id = id; el.className = 'page-overlay'; el.setAttribute('aria-live','polite'); el.setAttribute('aria-busy','true');
      el.innerHTML = `
        <div class="card">
          <div class="spinner"><img src="${src}" alt="è¼‰å…¥ä¸­" class="loading-img"></div>
          <div class="title">${text}</div>
          <div class="muted" style="font-size:.9rem">æ­£åœ¨æº–å‚™è³‡æ–™èˆ‡ä»‹é¢</div>
        </div>`;
      document.body.appendChild(el);
    }else{
      const img = el.querySelector('.loading-img'); if(img) img.src = src;
      const ttl = el.querySelector('.title'); if(ttl) ttl.textContent = text;
    }
    return el;
  }
  function show(key='global', text){
    const id=`ov-${key}`; const el=ensure(id, text||'è¼‰å…¥ä¸­ï¼Œè«‹ç¨å€™â€¦', key);
    el.classList.remove('hide'); map.set(id, Date.now()); lock(true); return id;
  }
  function hide(key='global'){
    const id=`ov-${key}`; const el=document.getElementById(id); if(!el) return;
    const start=map.get(id)||Date.now(); const wait=Math.max(0, MIN-(Date.now()-start));
    setTimeout(()=>{
      el.classList.add('hide');
      el.addEventListener('transitionend', ()=>{
        el.remove();
        if(!document.querySelector('.page-overlay') && !document.getElementById('page-loading')) lock(false);
      }, {once:true});
      map.delete(id);
    }, wait);
  }
  function videoShow(){
    const host=document.getElementById('v-frame'); if(!host) return Date.now();
    let m=host.querySelector('.mini-overlay');
    const src = LOADER_IMG.video || LOADER_IMG.global || 'è½‰åœˆåœˆ.png';
    if(!m){
      m=document.createElement('div');
      m.className='mini-overlay';
      m.innerHTML=`<div class="spinner"><img src="${src}" alt="" class="loading-img"></div>`;
      host.appendChild(m);
    }else{
      const img=m.querySelector('.loading-img'); if(img) img.src=src;
    }
    return Date.now();
  }
  function videoHide(mark){
    const host=document.getElementById('v-frame'); if(!host) return;
    const m=host.querySelector('.mini-overlay'); if(!m) return;
    const left=Math.max(0, 1200 - (Date.now() - (mark||Date.now())));
    setTimeout(()=> m.remove(), left);
  }
  return { show, hide, videoShow, videoHide, ensure };
})();

/* ========= QA è¤‡è£½ï¼šæŒ‰éˆ•/å‹•ç•«/Toast ========= */
(function setupQACopy(){
  const list = document.getElementById('qa-list'); if(!list) return;
  function ensureCopyButtons(root=list){
    root.querySelectorAll('.item').forEach(item=>{
      if(item.querySelector('.tool.copy-qa')) return;
      const header=item.querySelector('.q'); if(!header) return;
      const tools=header.querySelector('.tools')||(()=>{const t=document.createElement('div');t.className='tools';t.style.marginLeft='auto';t.style.display='flex';t.style.gap='8px';header.appendChild(t);return t;})();
      const btn=document.createElement('span'); btn.className='tool copy-qa'; btn.setAttribute('role','button'); btn.setAttribute('tabindex','0'); btn.title='è¤‡è£½é€™å‰‡ QA'; btn.textContent='ğŸ“‹ è¤‡è£½';
      tools.appendChild(btn);
    });
  }
  function toastAt(text, rect){
    const tip=document.createElement('div'); tip.className='toast'; tip.textContent=text;
    const y=Math.max(12, window.scrollY + rect.top - 14);
    const x=Math.min(window.innerWidth-12, Math.max(12, window.scrollX + rect.left + rect.width/2));
    tip.style.top=`${y}px`; tip.style.left=`${x}px`; tip.style.transform='translate(-50%,0)';
    document.body.appendChild(tip); setTimeout(()=>tip.remove(), 1650);
  }
  async function doCopy(fromEl, btn){
    const item=fromEl.closest('.item'); const txt=item?.querySelector('.a-inner')?.innerText?.trim(); if(!txt) return;
    await navigator.clipboard.writeText(txt); btn.classList.add('copied'); setTimeout(()=>btn.classList.remove('copied'), 420);
    toastAt('å·²è¤‡è£½ QA', btn.getBoundingClientRect());
  }
  document.addEventListener('click', e=>{ const btn=e.target.closest('.tool.copy-qa,[data-copy]'); if(!btn) return; e.preventDefault(); doCopy(btn, btn); });
  document.addEventListener('keydown', e=>{ if((e.key==='Enter'||e.key===' ') && e.target.closest('.tool.copy-qa')){ e.preventDefault(); doCopy(e.target, e.target);} });
  ensureCopyButtons();
  new MutationObserver(m=>m.forEach(x=>x.addedNodes.forEach(n=>{ if(n.nodeType===1) ensureCopyButtons(n); }))).observe(list, {childList:true, subtree:true});
})();

/* ========= å½±ç‰‡ï¼šé»ä¸€æ¬¡åªæ¸²æŸ“ä¸€æ¬¡ + æ’­æ”¾å™¨å°é®ç½© ========= */
(function videoClickOnce(){
  const list=document.getElementById('v-list'), frame=document.getElementById('v-frame'), title=document.getElementById('v-title');
  if(!list||!frame) return;
  let lock=false, lastKey='';
  list.addEventListener('click', (e)=>{
    const item=e.target.closest('[data-video]'); if(!item) return;
    if(lock) return; lock=true; setTimeout(()=>lock=false,600);
    try{
      const data=JSON.parse(item.dataset.video||'{}'); const key=(data.id||data.url||'')+'|'+(data.title||''); if(key===lastKey) return; lastKey=key;
      frame.innerHTML='';
      const wrap=document.createElement('div'); wrap.className='video-embed';
      wrap.innerHTML=`<iframe src="${data.url||''}" allowfullscreen loading="lazy" referrerpolicy="strict-origin-when-cross-origin"></iframe>`;
      frame.appendChild(wrap); if(title) title.textContent=data.title||'å½±ç‰‡';
      // å°é®ç½©
      const mark=Loading.videoShow();
      const timer=setInterval(()=>{
        const ifr=frame.querySelector('iframe');
        if(ifr){ clearInterval(timer); ifr.addEventListener('load',()=>Loading.videoHide(mark), {once:true}); setTimeout(()=>Loading.videoHide(mark), 5000); }
      }, 60);
      setTimeout(()=>clearInterval(timer),2000);
    }catch{}
  }, true);
})();

/* ========= QA åˆ†é ï¼šå…¨é é®ç½© + æ²é ‚ ========= */
(function qaPagingOverlay(){
  const ids=['prev','next','page'], list=document.getElementById('qa-list'); if(!list) return;
  function armHide(){
    const mo=new MutationObserver(()=>{
      clearTimeout(armHide.t); armHide.t=setTimeout(()=>Loading.hide('page'), 240);
    });
    mo.observe(list, {childList:true, subtree:true}); setTimeout(()=>{ mo.disconnect(); Loading.hide('page'); }, 8000);
  }
  ids.forEach(id=>{
    const el=document.getElementById(id); if(!el) return;
    const evt=(id==='page')?'change':'click';
    el.addEventListener(evt, ()=>{
      Loading.show('page','åˆ‡æ›é é¢ä¸­ï¼Œè«‹ç¨å€™â€¦'); armHide();
      window.scrollTo({top:0,behavior:'smooth'});
    });
  });
})();

/* ========= AI è¨Šæ¯å»é‡ ========= */
(function dedupeAssistant(){
  const box=document.getElementById('ai-messages'); if(!box) return;
  let t=null; const mo=new MutationObserver(()=>{
    clearTimeout(t); t=setTimeout(()=>{
      const b=[...box.querySelectorAll('.msg.assistant .bubble')]; if(b.length<2) return;
      const a=b[b.length-2]?.textContent?.trim(), c=b[b.length-1]?.textContent?.trim();
      if(a&&c&&a===c) b[b.length-1].closest('.msg.assistant')?.remove();
    },50);
  }); mo.observe(box,{childList:true,subtree:true});
})();

/* ========= èªéŸ³ï¼ˆå–®ä¸€ç‰ˆæœ¬ï¼Œé˜²é‡è¤‡å®£å‘Šï¼‰ ========= */
window.Voice ??= (() => {
  let rec=null, recOn=false, ttsOn=false, inited=false;
  function btnMic(){ return document.getElementById('ai-mic'); }
  function btnTTS(){ return document.getElementById('ai-tts'); }
  function lastAssistantText(){ return document.querySelector('#ai-messages .msg.assistant:last-of-type .bubble')?.textContent?.trim(); }
  function toggleRec(){
    if(!rec){ alert('æ­¤ç€è¦½å™¨ä¸æ”¯æ´èªéŸ³è¼¸å…¥'); return; }
    if(recOn){ rec.stop(); recOn=false; btnMic()?.classList.remove('rec'); return; }
    try{ rec.start(); recOn=true; btnMic()?.classList.add('rec'); }catch{}
  }
  function speak(text){
    if(!('speechSynthesis' in window) || !text) return;
    speechSynthesis.cancel();
    const u=new SpeechSynthesisUtterance(text);
    const useVoice=(voices)=>{ const v=voices.find(v=>/zh[-_]?TW/i.test(v.lang))||voices.find(v=>/zh/i.test(v.lang))||voices[0]; if(v) u.voice=v; speechSynthesis.speak(u); };
    const vs=speechSynthesis.getVoices(); if(vs.length) useVoice(vs);
    else speechSynthesis.addEventListener('voiceschanged', function onv(){ speechSynthesis.removeEventListener('voiceschanged', onv); useVoice(speechSynthesis.getVoices()); });
  }
  function toggleTTS(){
    ttsOn=!ttsOn; btnTTS()?.classList.toggle('on', ttsOn);
    if(!('speechSynthesis' in window)) return;
    if(!ttsOn) speechSynthesis.cancel(); else { const t=lastAssistantText(); if(t) speak(t); }
  }
  function init(){
    if(inited) return; inited=true;
    const SR=window.SpeechRecognition||window.webkitSpeechRecognition;
    if(SR){
      rec=new SR(); rec.lang='zh-TW'; rec.interimResults=false; rec.continuous=false;
      rec.addEventListener('result',(e)=>{ const text=Array.from(e.results).map(r=>r[0].transcript).join('').trim(); const input=document.getElementById('ai-text'); if(input) input.value=text; document.getElementById('ai-form')?.dispatchEvent(new Event('submit',{cancelable:true,bubbles:true})); });
      rec.addEventListener('end',()=>{ recOn=false; btnMic()?.classList.remove('rec'); });
    }
    btnMic()?.addEventListener('click', toggleRec);
    btnTTS()?.addEventListener('click', toggleTTS);
    const list=document.getElementById('ai-messages');
    if(list){
      const obs=new MutationObserver(()=>{ if(!ttsOn) return; const t=lastAssistantText(); if(t) speak(t); });
      obs.observe(list,{childList:true,subtree:true});
    }
  }
  return { init, toggleRec, toggleTTS, speak };
})();
document.addEventListener('DOMContentLoaded', ()=> window.Voice.init());

/* ========= åˆ†é åˆ‡æ›ï¼ˆQA â†” å½±ç‰‡ï¼‰ä¹Ÿé¡¯ç¤ºè½‰åœˆåœˆï¼ˆå„ç”¨å„çš„åœ–ç‰‡ï¼‰ ========= */
(function tabsOverlay(){
  const tabVideo=document.getElementById('tab-video');
  const tabQA=document.getElementById('tab-qa');
  const videoPanel=document.getElementById('video-panel');
  const qaPanel=document.getElementById('qa-panel');

  function waitPanelReady(panel, readySelector, key){
    const readyObs = new MutationObserver(()=>{
      if(panel.querySelector(readySelector)){
        readyObs.disconnect(); Loading.hide(key);
      }
    });
    readyObs.observe(panel,{childList:true,subtree:true});
    setTimeout(()=>{ readyObs.disconnect(); Loading.hide(key); }, 5000);
  }

  tabVideo?.addEventListener('click', ()=>{
    Loading.show('tab-video','è¼‰å…¥å½±ç‰‡é é¢ä¸­ï¼Œè«‹ç¨å€™â€¦');
    setTimeout(()=> waitPanelReady(videoPanel, '#v-list *, iframe', 'tab-video'), 0);
  });

  tabQA?.addEventListener('click', ()=>{
    Loading.show('tab-qa','è¼‰å…¥ QA é é¢ä¸­ï¼Œè«‹ç¨å€™â€¦');
    setTimeout(()=> waitPanelReady(qaPanel, '.item', 'tab-qa'), 0);
  });
})();

/* ========= åˆ†äº«ï¼ˆç¸®çŸ­æ–‡æ¡ˆï¼‰ ========= */
(function shareFix(){
  const btn=document.getElementById('site-share'); if(!btn) return;
  btn.addEventListener('click', async ()=>{
    const data={title:document.title, text:'é¹¿ğŸ¦Œçš„QAç¶²ç«™', url:location.href};
    try{
      if(navigator.share){ await navigator.share(data); }
      else{ await navigator.clipboard.writeText(location.href); const old=btn.textContent; btn.textContent='å·²è¤‡è£½'; setTimeout(()=>btn.textContent=old,1200); }
    }catch{
      const old=btn.textContent; btn.textContent='å–æ¶ˆ'; setTimeout(()=>btn.textContent=old,1000);
    }
  });
})();

/* ========= åˆ†é è¡Œç‚ºï¼šæ›é å¾Œå›åˆ°æœ€ä¸Šé¢ï¼ˆå†ä¿éšªï¼‰ ========= */
['prev','next','page'].forEach(id=>{
  const el=document.getElementById(id); if(!el) return;
  const evt=id==='page'?'change':'click';
  el.addEventListener(evt, ()=> window.scrollTo({top:0,behavior:'smooth'}));
});

/* ==== AI é–‹/é—œé¢æ¿ï¼šåªåœ¨é–‹å•Ÿèˆ‡é—œé–‰æ™‚é¡¯ç¤ºè½‰åœˆåœˆï¼ŒèŠå¤©ä¸­ä¸é¡¯ç¤º ==== */
(function aiPanelOverlay(){
  const fab   = document.getElementById('ai-fab');
  const close = document.getElementById('ai-close');
  const panel = document.getElementById('ai-panel');

  function waitUntil(testFn, key){
    const start = Date.now();
    const it = setInterval(()=>{
      if (testFn()) { clearInterval(it); Loading.hide(key); }
      else if (Date.now() - start > 5000) { clearInterval(it); Loading.hide(key); } // ä¿åº•
    }, 60);
  }

  fab?.addEventListener('click', ()=>{
    Loading.show('ai-open', 'é–‹å•Ÿ AI ä¸­ï¼Œè«‹ç¨å€™â€¦');
    waitUntil(()=> !panel.classList.contains('hidden') || panel.classList.contains('show'), 'ai-open');
  });

  close?.addEventListener('click', ()=>{
    Loading.show('ai-close', 'é—œé–‰ AI ä¸­â€¦');
    waitUntil(()=> panel.classList.contains('hidden') && !panel.classList.contains('show'), 'ai-close');
  });
})();
(function(){
  const Î© = { live:false };
  let k = localStorage.getItem('deerPIN') || '9527';

  function deny(){ console.warn('ShadowOps :: gated'); }

  const Ops = {
    attune(tok){
      if(String(tok)===String(k)){ Î©.live=true; console.info('ShadowOps :: channel up'); return true; }
      console.warn('ShadowOps :: token mismatch'); return false;
    },
    sever(){ Î©.live=false; console.info('ShadowOps :: channel down'); },
    rekey(tok){
      if(!Î©.live) return deny();
      k = String(tok||''); localStorage.setItem('deerPIN', k);
      console.info('ShadowOps :: token rotated');
    },
    pulse(){ return { online:Î©.live, hint: k? (k[0]+'***'):'n/a' }; },

    /* veils (loaders/overlays) */
    despin(){
      if(!Î©.live) return deny();
      try{
        document.querySelectorAll('#page-loading,.page-overlay,.mini-overlay').forEach(n=>n.remove());
        document.body.style.overflow='';
        console.info('ShadowOps :: veils dropped');
      }catch(e){ console.error(e); }
    },
    pingveil(key='probe', note='phase checkâ€¦'){
      if(!Î©.live) return deny();
      if(window.Loading?.show){
        Loading.show(key, note);
        setTimeout(()=>Loading.hide(key), 1200);
        console.info('ShadowOps :: veil ping');
      }else{
        console.warn('ShadowOps :: no veil runtime');
      }
    },

    /* QA fold */
    unfurl(){
      if(!Î©.live) return deny();
      const items=document.querySelectorAll('#qa-list .item');
      items.forEach(it=>{ it.classList.add('open'); const a=it.querySelector('.a'); if(a) a.style.height='auto'; });
      console.info(`ShadowOps :: unfurled ${items.length}`);
    },
    refurl(){
      if(!Î©.live) return deny();
      const items=document.querySelectorAll('#qa-list .item.open');
      items.forEach(it=>{ it.classList.remove('open'); const a=it.querySelector('.a'); if(a) a.style.height='0px'; });
      console.info(`ShadowOps :: refurled ${items.length}`);
    },

    /* video */
    reforgeFrame(){
      if(!Î©.live) return deny();
      const host=document.querySelector('#v-frame'); if(!host){ console.warn('ShadowOps :: no v-frame'); return; }
      const cur=host.querySelector('iframe')?.src||'';
      host.innerHTML='';
      const w=document.createElement('div'); w.className='video-embed';
      w.innerHTML=`<iframe src="${cur}" allowfullscreen loading="lazy" referrerpolicy="strict-origin-when-cross-origin"></iframe>`;
      host.appendChild(w);
      console.info('ShadowOps :: frame reforged');
    },

    /* AI panel */
    paneOn(){
      if(!Î©.live) return deny();
      const p=document.getElementById('ai-panel'); if(p){ p.classList.remove('hidden'); p.classList.add('show'); console.info('ShadowOps :: pane up'); }
    },
    paneOff(){
      if(!Î©.live) return deny();
      const p=document.getElementById('ai-panel'); if(p){ p.classList.add('hidden'); p.classList.remove('show'); console.info('ShadowOps :: pane down'); }
    },

    purgeVeils(){
      if(!Î©.live) return deny();
      document.querySelectorAll('.page-overlay,.mini-overlay').forEach(n=>n.remove());
      console.info('ShadowOps :: purged veils');
    },

    lexicon(){
      console.table([
        {call:'ShadowOps.attune("<pin>")',   note:'enter channel (PIN)'},
        {call:'ShadowOps.sever()',           note:'leave channel'},
        {call:'ShadowOps.rekey("<pin>")',    note:'rotate token'},
        {call:'ShadowOps.pulse()',           note:'telemetry'},
        {call:'ShadowOps.despin()',          note:'drop all veils/loaders'},
        {call:'ShadowOps.pingveil()',        note:'1.2s test veil'},
        {call:'ShadowOps.unfurl()',          note:'open all QA'},
        {call:'ShadowOps.refurl()',          note:'close all QA'},
        {call:'ShadowOps.reforgeFrame()',    note:'recreate video iframe'},
        {call:'ShadowOps.paneOn()',          note:'force AI panel show'},
        {call:'ShadowOps.paneOff()',         note:'force AI panel hide'},
        {call:'ShadowOps.purgeVeils()',      note:'clear overlays'},
      ]);
      console.info('ShadowOps :: gated calls require attune() first');
    }
  };

  // expose under a non-obvious handle
  Object.defineProperty(window, 'ShadowOps', { value:Ops, configurable:false, enumerable:false, writable:false });

  // logo quint-click â†’ PIN prompt
  const logo=document.getElementById('logo-img');
  let taps=0, t=null;
  logo?.addEventListener('click', ()=>{
    taps++; clearTimeout(t); t=setTimeout(()=>taps=0, 820);
    if(taps>=5){ taps=0; const tok=prompt('ShadowOps token'); if(tok) Ops.attune(tok); }
  });

  // console hint (discreet)
  try{ console.log('%cShadowOps ready :: use ShadowOps.lexicon()', 'color:#72f5dd'); }catch{}
})();
  </script>
</body>
</html>